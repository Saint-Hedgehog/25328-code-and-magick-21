(()=>{"use strict";window.GameConstants={Fireball:{size:fireballSize||24,speed:getFireballSpeed||function(e){return e?2:5}},Wizard:{speed:wizardSpeed||2,width:wizardWidth||61,getHeight:getWizardHeight||function(e){return 1.377*e},getX:getWizardX||function(e){return e/3},getY:getWizardY||function(e){return e-100}}},window.Game=function(){var e=300,t=700,s=["Кекс","Катя","Игорь"],i={},n="-reversed";i[0]={width:61,height:84,url:"img/wizard.gif"},i[0+n]={width:61,height:84,url:"img/wizard-reversed.gif"},i[1]={width:24,height:24,url:"img/fireball.gif"};var r={0:function(s,i,n){i.keysPressed.UP&&s.y>0&&(s.direction=-9&s.direction,s.direction=4|s.direction,s.y-=s.speed*n*2),i.keysPressed.UP||s.y<e-s.height&&(s.direction=-5&s.direction,s.direction=8|s.direction,s.y+=s.speed*n/3),i.keysPressed.LEFT&&(s.direction=-3&s.direction,s.direction=1|s.direction,s.x-=s.speed*n),i.keysPressed.RIGHT&&(s.direction=-2&s.direction,s.direction=2|s.direction,s.x+=s.speed*n),s.y<0&&(s.y=0),s.y>e-s.height&&(s.y=e-s.height),s.x<0&&(s.x=0),s.x>t-s.width&&(s.x=t-s.width)},1:function(e,s,i){1&e.direction&&(e.x-=e.speed*i),2&e.direction&&(e.x+=e.speed*i),(e.x<0||e.x>t)&&(e.state=1)}},a={CONTINUE:0,WIN:1,FAIL:2,PAUSE:3,INTRO:4},o={0:function(e){return e.garbage.filter((function(e){return 1===e.type})).filter((function(e){return e.x<10&&e.y>240}))[0]?a.WIN:a.CONTINUE}},d={0:function(s){return s.objects.push({direction:2,height:window.GameConstants.Wizard.getHeight(window.GameConstants.Wizard.width),speed:window.GameConstants.Wizard.speed,sprite:i[0],state:0,type:0,width:window.GameConstants.Wizard.width,x:window.GameConstants.Wizard.getX(t),y:window.GameConstants.Wizard.getY(e)}),s}},l=function(e){this.container=e,this.canvas=document.createElement("canvas"),this.canvas.width=e.clientWidth,this.canvas.height=e.clientHeight,this.container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._pauseListener=this._pauseListener.bind(this),this.setDeactivated(!1)};l.prototype={level:0,setDeactivated:function(e){this._deactivated!==e&&(this._deactivated=e,e?this._removeGameListeners():this._initializeGameListeners())},getInitialState:function(){return{currentStatus:a.CONTINUE,garbage:[],lastUpdated:null,keysPressed:{ESC:!1,LEFT:!1,RIGHT:!1,SPACE:!1,UP:!1},levelStartTime:null,objects:[],startTime:null}},initializeLevelAndStart:function(e){(e=void 0===e||e)||!this.state?(this._imagesArePreloaded=void 0,this.state=this.getInitialState(),this.state=d[this.level](this.state)):this.state.currentStatus=a.CONTINUE,this.state.levelStartTime=Date.now(),this.state.startTime||(this.state.startTime=this.state.levelStartTime),this._preloadImagesForLevel(function(){this.render(),this._initializeGameListeners(),this.update()}.bind(this))},pauseLevel:function(e){e&&(this.state.currentStatus=e),this.state.keysPressed.ESC=!1,this.state.lastUpdated=null,this._removeGameListeners(),window.addEventListener("keydown",this._pauseListener),this._drawPauseScreen()},_pauseListener:function(e){if(32===e.keyCode&&!this._deactivated){e.preventDefault();var t=this.state.currentStatus===a.WIN||this.state.currentStatus===a.FAIL;this.initializeLevelAndStart(t),window.removeEventListener("keydown",this._pauseListener)}},_drawPauseScreen:function(){var e;switch(this.state.currentStatus){case a.WIN:if(window.renderStatistics){var t=this._generateStatistics(new Date-this.state.startTime),s=this._shuffleArray(Object.keys(t));return void window.renderStatistics(this.ctx,s,s.map((function(e){return t[e]})))}e="Вы победили Газебо!\nУра!";break;case a.FAIL:e="Вы проиграли!";break;case a.PAUSE:e="Игра на паузе!\nНажмите Пробел, чтобы продолжить";break;case a.INTRO:e="Добро пожаловать!\nНажмите Пробел для начала игры"}this._drawMessage(e)},_generateStatistics:function(e){for(var t={Вы:e},i=0;i<s.length;i++){var n=e+(3e3*Math.random()-1500);n<1e3&&(n=1e3),t[s[i]]=n}return t},_shuffleArray:function(e){for(var t=e.length-1;t>0;t--){var s=Math.floor(Math.random()*(t+1)),i=e[t];e[t]=e[s],e[s]=i}return e},_drawMessage:function(e){var t=this.ctx,s=function(e,s,i,n){t.beginPath(),t.moveTo(e,s),t.lineTo(e+10,s+n/2),t.lineTo(e,s+n),t.lineTo(e+i/2,s+n-10),t.lineTo(e+i,s+n),t.lineTo(e+i-10,s+n/2),t.lineTo(e+i,s),t.lineTo(e+i/2,s+10),t.lineTo(e,s),t.stroke(),t.closePath(),t.fill()};t.fillStyle="rgba(0, 0, 0, 0.7)",s(190,40,320,100),t.fillStyle="rgba(256, 256, 256, 1.0)",s(180,30,320,100),t.fillStyle="#000",t.font="16px PT Mono",e.split("\n").forEach((function(e,s){t.fillText(e,200,80+20*s)}))},_preloadImagesForLevel:function(e){if(void 0===this._imagesArePreloaded&&(this._imagesArePreloaded=[]),this._imagesArePreloaded[this.level])e();else for(var t=Object.keys(i),s=t.length,n=this,r=function(t){var i=new Image(t.width,t.height);i.onload=function(){t.image=i,0==--s&&(n._imagesArePreloaded[n.level]=!0,e())},i.src=t.url},a=0;a<t.length;a++)r(i[t[a]])},updateObjects:function(e){var t=this.state.objects.filter((function(e){return 0===e.type}))[0];this.state.keysPressed.SHIFT&&(this.state.objects.push({direction:t.direction,height:window.GameConstants.Fireball.size,speed:window.GameConstants.Fireball.speed(!!(1&t.direction)),sprite:i[1],type:1,width:window.GameConstants.Fireball.size,x:2&t.direction?t.x+t.width:t.x-window.GameConstants.Fireball.size,y:t.y+t.height/2}),this.state.keysPressed.SHIFT=!1),this.state.garbage=[];var s=this.state.objects.filter((function(t){return r[t.type](t,this.state,e),1!==t.state||(this.state.garbage.push(t),!1)}),this);this.state.objects=s},checkStatus:function(){if(this.state.currentStatus===a.CONTINUE){this.commonRules||(this.commonRules=[function(e){return 1===e.objects.filter((function(e){return 0===e.type}))[0].state?a.FAIL:a.CONTINUE},function(e){return e.keysPressed.ESC?a.PAUSE:a.CONTINUE},function(e){return Date.now()-e.startTime>18e4?a.FAIL:a.CONTINUE}]);for(var e=this.commonRules.concat(o[this.level]),t=a.CONTINUE;t===a.CONTINUE&&e.length;)t=e.shift()(this.state);this.state.currentStatus=t}},setGameStatus:function(e){this.state.currentStatus!==e&&(this.state.currentStatus=e)},render:function(){this.ctx.clearRect(0,0,t,e),this.state.objects.forEach((function(e){if(e.sprite){var t=1&e.direction,s=i[e.type+(t?n:"")]||i[e.type];this.ctx.drawImage(s.image,e.x,e.y,e.width,e.height)}}),this)},update:function(){this.state.lastUpdated||(this.state.lastUpdated=Date.now());var e=(Date.now()-this.state.lastUpdated)/10;switch(this.updateObjects(e),this.checkStatus(),this.state.currentStatus){case a.CONTINUE:this.state.lastUpdated=Date.now(),this.render(),requestAnimationFrame(function(){this.update()}.bind(this));break;case a.WIN:case a.FAIL:case a.PAUSE:case a.INTRO:this.pauseLevel()}},_onKeyDown:function(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!0;break;case 39:this.state.keysPressed.RIGHT=!0;break;case 38:this.state.keysPressed.UP=!0;break;case 27:this.state.keysPressed.ESC=!0}e.shiftKey&&(this.state.keysPressed.SHIFT=!0)},_onKeyUp:function(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!1;break;case 39:this.state.keysPressed.RIGHT=!1;break;case 38:this.state.keysPressed.UP=!1;break;case 27:this.state.keysPressed.ESC=!1}e.shiftKey&&(this.state.keysPressed.SHIFT=!1)},_initializeGameListeners:function(){window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp)},_removeGameListeners:function(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp)}},l.Verdict=a;var c=new l(document.querySelector(".demo"));return window.restartGame=function(e,t){i[0].url=e,i[0+n].url=t,c.initializeLevelAndStart(),c.setGameStatus(a.INTRO)},window.restartGame("img/wizard.gif","img/wizard-reversed.gif"),c}(),window.utils={isEscEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())},isEnterEvent:(e,t)=>{"Enter"===e.key&&t()},getRandomElement:e=>e[Math.floor(Math.random()*e.length)],createErrorMessage:e=>{let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center",t.style.width="790px",t.style.height="90px",t.style.paddingTop="45px",t.style.backgroundColor="navy",t.style.border="5px solid white",t.style.position="absolute",t.style.top="180px",t.style.left=0,t.style.right=0,t.style.fontSize="35px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}},(()=>{const{isEscEvent:e}=window.utils,t=document.querySelector(".setup"),s=t.querySelector(".setup-user-name"),i=document.querySelector(".setup-open"),n=t.querySelector(".setup-close"),r=t.querySelector(".upload"),a=t.querySelector(".setup-wizard-form"),o=()=>{l()},d=t=>{e(t,l)},l=()=>{document.querySelector(".success-message").remove(),document.removeEventListener("click",o),document.removeEventListener("keydown",d)};window.elements={MIN_NAME_LENGTH:2,MAX_NAME_LENGTH:25,userDialog:t,setupUserName:s,setupOpen:i,setupClose:n,dialogHandle:r,userForm:a,onSuccessSubmit:e=>{t.classList.add("hidden");const s=document.createElement("div");s.classList.add("success-message"),s.style="z-index: 100; margin: 0 auto; text-align: center",s.style.width="792px",s.style.height="90px",s.style.paddingTop="40px",s.style.paddingBottom="25px",s.style.backgroundColor="GreenYellow",s.style.color="black",s.style.border="5px solid black",s.style.position="absolute",s.style.top="180px",s.style.left=0,s.style.right=0,s.style.fontSize="35px",s.textContent=e.username+"! Ваши данные успешно отправлены",document.body.insertAdjacentElement("afterbegin",s),document.addEventListener("click",l),document.addEventListener("keydown",d)}}})(),window.debounce=function(e){let t=null;return function(...s){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...s)}),500)}},(()=>{const e=(e,t,s,i,n)=>{const r=new XMLHttpRequest;r.responseType="json",r.timeout=3e3,r.open(e,t),r.send(s),r.addEventListener("load",(()=>{200===r.status?i(r.response):n(`Статус ответа: ${r.status} ${r.statusText}`)})),r.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за  ${r.timeout}мс`)}))};window.backend={load(t,s){e("GET","https://javascript.pages.academy/code-and-magick/data",null,t,s)},save(t,s,i){e("POST","https://javascript.pages.academy/code-and-magick",t,s,i)}}})(),(()=>{const e=["rgb(146, 100, 161)","rgb(215, 210, 55)","rgb(241, 43, 107)","rgb(101, 137, 164)","rgb(0, 0, 0)","rgb(215, 210, 55)","rgb(56, 159, 117)","rgb(241, 43, 107)"],t=["red","orange","yellow","green","lightblue","blue","purple"],s=["#ee4830","#30a8ee","#5ce6c0","#e848d5","#e6e848"],{getRandomElement:i}=window.utils,n={onEyesChange(){},onCoatChange(){}},r=document.querySelector(".setup-wizard"),a=r.querySelector(".wizard-coat"),o=r.querySelector(".wizard-eyes"),d=document.querySelector(".setup-fireball-wrap");window.wizard={setCoatChangeHandler(e){n.onCoatChange=e},setEyesChangeHandler(e){n.onEyesChange=e},onWizardCoatColorGet:t=>{const s=i(e);t.target.style.fill=s,n.onCoatChange(s)},onWizardEyesColorGet:e=>{const s=i(t);e.target.style.fill=s,n.onEyesChange(s)},onWizardFireballColorGet:()=>{const e=i(s);d.setAttribute("style","background-color:"+e),d.querySelector("input").value=e},wizardCoatElement:a,wizardEyesElement:o,wizardFireballElement:d}})(),(()=>{const{load:e}=window.backend,{setEyesChangeHandler:t,setCoatChangeHandler:s}=window.wizard;let i="rgb(101, 137, 164)",n="black",r=[];const a=e=>{let t=0;return e.colorCoat===i&&(t+=2),e.colorEyes===n&&(t+=1),t},o=window.debounce((()=>{window.render(r.sort(((e,t)=>{let s=a(t)-a(e);return 0===s&&(s=((e,t)=>e>t?1:e<t?-1:0)(e.name,t.name)),s})))}));t((e=>{n=e,o()})),s((e=>{i=e,o()})),e((e=>{r=e,o()}),(e=>{window.utils.createErrorMessage(e)}))})(),(()=>{const e=document.querySelector("#similar-wizard-template"),t=t=>{const s=e.content.cloneNode(!0),i=s.querySelector(".wizard");return i.querySelector(".wizard-coat").style.fill=t.colorCoat,i.querySelector(".wizard-eyes").style.fill=t.colorEyes,s.querySelector(".setup-similar-label").innerText=t.name,s},s=document.querySelector(".setup-similar"),i=document.querySelector(".setup-similar-list");window.render=e=>{const n=e.length>4?4:e.length;i.innerHTML="";for(let s=0;s<n;s++)i.appendChild(t(e[s]));s.classList.remove("hidden")}})(),(()=>{const{MIN_NAME_LENGTH:e,MAX_NAME_LENGTH:t,setupUserName:s}=window.elements;s.addEventListener("invalid",(()=>{s.validity.valueMissing?s.setCustomValidity("Обязательное поле"):s.setCustomValidity("")})),s.addEventListener("input",(()=>{let i=s.value.length;i<e?s.setCustomValidity(`Ещё ${e-i} симв.`):i>t?s.setCustomValidity(`Удалите лишние ${i-t} симв.`):s.setCustomValidity("")}))})(),(()=>{const{userDialog:e,dialogHandle:t}=window.elements;window.shift={moveOn:s=>{s.preventDefault();let i={x:s.clientX,y:s.clientY},n=!1;const r=t=>{t.preventDefault(),n=!0;const s=i.x-t.clientX,r=i.y-t.clientY;i={x:t.clientX,y:t.clientY},e.style.top=e.offsetTop-r+"px",e.style.left=e.offsetLeft-s+"px"},a=e=>{if(e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",a),n){const e=s=>{s.preventDefault(),t.removeEventListener("click",e)};t.addEventListener("click",e)}};document.addEventListener("mousemove",r),document.addEventListener("mouseup",a)}}})(),(()=>{const{setupUserName:e,userDialog:t,setupOpen:s,setupClose:i,dialogHandle:n,onSuccessSubmit:r,onError:a,userForm:o}=window.elements,{onWizardCoatColorGet:d,onWizardEyesColorGet:l,onWizardFireballColorGet:c,wizardCoatElement:u,wizardEyesElement:h,wizardFireballElement:m}=window.wizard,{isEscEvent:w,isEnterEvent:y}=window.utils,{moveOn:v}=window.shift,{save:p}=window.backend,f=()=>{t.classList.remove("hidden"),s.removeEventListener("click",E),s.removeEventListener("keydown",b),i.addEventListener("click",L),i.addEventListener("keydown",S),i.addEventListener("keydown",k),u.addEventListener("click",d),h.addEventListener("click",l),m.addEventListener("click",c),n.addEventListener("mousedown",v)},g=()=>{t.classList.add("hidden"),s.addEventListener("click",E),s.addEventListener("keydown",b),i.removeEventListener("click",L),i.removeEventListener("keydown",S),i.removeEventListener("keydown",k),u.removeEventListener("click",d),h.removeEventListener("click",l),m.removeEventListener("click",c),n.removeEventListener("mousedown",v)},E=()=>{f()},b=e=>{y(e,f)};s.addEventListener("click",E),s.addEventListener("keydown",b);const L=()=>{g()},k=e=>{i.matches(":focus")&&y(e,g)},S=t=>{e.matches(":focus")||w(t,g)};o.addEventListener("submit",(e=>{p(new FormData(o),r,a),e.preventDefault(),g()}))})(),(()=>{const e=(e,t,s,i)=>{e.fillStyle=i,e.fillRect(t,s,420,270)},t=(e,t,s,i,n)=>{e.fillStyle=t,e.font="16px PT Mono",e.fillText(s,i,n)};window.renderStatistics=(s,i,n)=>{e(s,110,20,"rgba(0, 0, 0, 0.7)"),e(s,100,10,"#ffffff"),t(s,"#000000","Ура вы победили!",130,40),t(s,"#000000","Список результатов:",130,60);const r=Math.max.apply(null,n);let a;i.forEach(((e,i)=>{a="Вы"===e?"rgba(255, 0, 0, 1)":`hsl(240, ${Math.floor(100*Math.random())}%, 50%)`,((e,s,i,n,r,a)=>{e.fillStyle=s,e.fillRect(130+i,250,40,-n),t(e,"#000000",r,130+i,270),t(e,"#000000",a,130+i,250-n-10)})(s,a,50*i*2,150*n[i]/r,e,Math.round(n[i]))}))}})()})();